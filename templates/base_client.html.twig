<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Client - App Review{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Ajout de SweetAlert2 pour de beaux popups -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="icon" href="{{ asset('images/logo.png') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ asset('images/logo.png') }}" type="image/x-icon">
    <style>
        body {
            min-height: 100vh;
            padding-top: 70px;
        }

        .nav-logo {
            height: 50px;
        }

        .navbar-fixed {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        #search-input {
            background-color: rgba(255,255,255,0.2);
            color: #fff;
            border: none;
            border-radius: 50px;
        }

        #search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        #search-input:focus {
            background-color: rgba(255,255,255,0.3);
            box-shadow: none;
        }

        /* Styles am√©lior√©s pour les notifications */
        .notification-dropdown {
            width: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .notification-item {
            cursor: pointer;
            padding: 12px 15px;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            border-left-color: #0d6efd;
            background-color: #f0f8ff;
        }

        .notification-item.read {
            border-left-color: #6c757d;
        }

        .notification-type {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
        }

        .notification-type.info {
            background-color: #17a2b8;
        }

        .notification-type.warning {
            background-color: #ffc107;
        }

        .notification-type.success {
            background-color: #28a745;
        }

        .notification-type.error {
            background-color: #dc3545;
        }

        .notification-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .notification-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .notification-item:hover .notification-actions {
            opacity: 1;
        }

        .delete-notification-btn {
            background: none;
            border: none;
            color: #dc3545;
            padding: 0;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .mark-read-btn {
            background: none;
            border: none;
            color: #0d6efd;
            padding: 0 5px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .notification-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            min-width: 18px;
        }

        .dropdown-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        .dropdown-footer {
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
        }
    </style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<!-- REMPLACER LA SECTION NAVBAR DANS base_client.html.twig -->

<nav class="navbar navbar-expand-lg navbar-dark bg-dark navbar-fixed">
    <div class="container-fluid">
        <!-- Logo -->
        <a class="navbar-brand d-flex align-items-center fw-bold" href="/">
            <img src="{{ asset('images/logo.png') }}" class="nav-logo me-2" alt="Logo">
            App-Review
        </a>

        <!-- Search -->
        <div class="collapse navbar-collapse justify-content-center">
            <form class="d-flex w-50 position-relative" action="{{ path('client_home') }}" method="GET">
                <input class="form-control ps-5" type="search" name="search" id="search-input"
                       placeholder="Rechercher un commerce ou une cat√©gorie">
                <i class="bi bi-search position-absolute"
                   style="left:15px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,0.7)"></i>
            </form>
        </div>

        <div class="d-flex ms-auto align-items-center gap-3">
            {% if app.user %}
                <!-- üîî NOTIFICATIONS -->
                <div class="dropdown">
                    <a class="nav-link position-relative text-white"
                       href="#"
                       role="button"
                       data-bs-toggle="dropdown"
                       onclick="loadNotifications()">
                        <i class="bi bi-bell fs-5"></i>
                        {% if unreadCount is defined and unreadCount > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge">
                                {{ unreadCount }}
                            </span>
                        {% endif %}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end p-3 notification-dropdown" id="notification-list">
                        <div class="dropdown-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Notifications</h6>
                            {% if unreadCount is defined and unreadCount > 0 %}
                                <button class="btn btn-sm btn-outline-primary" onclick="markAllAsRead()">
                                    <i class="bi bi-check-all"></i> Tout lire
                                </button>
                            {% endif %}
                        </div>
                        <div id="notifications-content"></div>
                    </ul>
                </div>

                <!-- üí¨ MESSAGES -->
                <div class="position-relative">
                    <a class="nav-link text-white d-flex align-items-center"
                       href="{{ path('messages_index') }}"
                       title="Messages">
                        <i class="bi bi-chat-dots fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success"
                              id="messagesUnreadBadge"
                              style="display: none; font-size: 0.7rem;">
                            0
                        </span>
                    </a>
                </div>

                <!-- üë§ MENU UTILISATEUR -->
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle text-white d-flex align-items-center"
                       href="#"
                       role="button"
                       data-bs-toggle="dropdown"
                       aria-expanded="false">
                        <i class="bi bi-person-circle fs-5 me-2"></i>
                        {{ app.user.name }}
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end shadow">
                        <!-- Home -->
                        <li>
                            <a class="dropdown-item" href="{{ path('client_home') }}">
                                <i class="bi bi-house me-2"></i> Accueil
                            </a>
                        </li>

                        <!-- Mon profil -->
                        <li>
                            <a class="dropdown-item" href="{{ path('user_profile') }}">
                                <i class="bi bi-person me-2"></i> Mon profil
                            </a>
                        </li>

                        <!-- Mes messages -->
                        <li>
                            <a class="dropdown-item" href="{{ path('messages_index') }}">
                                <i class="bi bi-chat-dots me-2"></i> Mes messages
                                {% set unreadMsgCount = app.user.unreadMessagesCount|default(0) %}
                                {% if unreadMsgCount > 0 %}
                                    <span class="badge bg-success ms-2">{{ unreadMsgCount }}</span>
                                {% endif %}
                            </a>
                        </li>

                        <li><hr class="dropdown-divider"></li>

                        {% if app.user.role == 'SERVICE_OWNER' %}
                            <!-- Mes businesses -->
                            <li>
                                <a class="dropdown-item" href="{{ path('owner_businesses') }}">
                                    <i class="bi bi-shop me-2"></i> Mes Businesses
                                </a>
                            </li>

                            <!-- Mes abonn√©s -->
                            <li>
                                <a class="dropdown-item" href="{{ path('my_subscribers') }}">
                                    <i class="bi bi-people me-2"></i> Mes Abonn√©s
                                    {% set subscribersCount = app.user.subscribers|filter(s => s.isActive)|length %}
                                    {% if subscribersCount > 0 %}
                                        <span class="badge bg-info ms-2">{{ subscribersCount }}</span>
                                    {% endif %}
                                </a>
                            </li>
                        {% endif %}

                        {% if app.user.role == 'CUSTOMER' %}
                            <!-- Mes abonnements -->
                            <li>
                                <a class="dropdown-item" href="{{ path('my_subscriptions') }}">
                                    <i class="bi bi-bell me-2"></i> Mes Abonnements
                                    {% set subscriptionsCount = app.user.subscriptions|filter(s => s.isActive)|length %}
                                    {% if subscriptionsCount > 0 %}
                                        <span class="badge bg-primary ms-2">{{ subscriptionsCount }}</span>
                                    {% endif %}
                                </a>
                            </li>
                        {% endif %}

                        {% if app.user.role == 'ADMIN' %}
                        <li>
                            <a class="dropdown-item" href="{{ path('admin_dashboard') }}">
                                <i class="bi bi-speedometer2 me-2"></i> Dashboard
                            </a>

                        </li>

                        {% endif %}




                            <li><hr class="dropdown-divider"></li>

                        <!-- D√©connexion -->
                        <li>
                            <a class="dropdown-item text-danger" href="{{ path('app_logout') }}">
                                <i class="bi bi-box-arrow-right me-2"></i> D√©connexion
                            </a>
                        </li>
                    </ul>
                </div>

            {% else %}
                <a class="btn btn-outline-light btn-sm" href="{{ path('app_login') }}">
                    Connexion
                </a>
            {% endif %}
        </div>
    </div>
</nav>

<style>
    .notification-badge,
    #messagesUnreadBadge {
        font-size: 0.7rem;
        padding: 2px 6px;
        min-width: 18px;
    }

    .nav-link:hover {
        transform: scale(1.05);
        transition: transform 0.2s ease;
    }

    .dropdown-menu {
        min-width: 250px;
    }

    .dropdown-item {
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
        padding-left: 1.2rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mettre √† jour le compteur de messages non lus

        async function updateMessagesCount() {
            try {
                const response = await fetch('{{ path('messages_unread_count') }}');
                const data = await response.json();

                const badge = document.getElementById('messagesUnreadBadge');
                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des messages:', error);
            }
        }

        // Mettre √† jour au chargement
        updateMessagesCount();

        // Rafra√Æchir toutes les 30 secondes
        setInterval(updateMessagesCount, 30000);
    });
</script>
<!-- ================= CONTENT ================= -->
<div class="container mt-4">
    {% block body %}{% endblock %}
</div>

<!-- ================= JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

    // Fonction pour charger les notifications
    function loadNotifications() {
        fetch('{{ path("notifications_list") }}')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('notifications-content');

                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-bell-slash fs-1 text-muted"></i>
                            <p class="text-muted mt-2">Aucune notification</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                data.forEach(n => {
                    const typeClass = getTypeClass(n.type);
                    const readClass = n.isRead ? 'read' : 'unread';
                    const badgeText = n.isRead ? 'Lu' : 'Nouveau';

                    html += `
                        <div class="notification-item ${readClass}"
                             onclick="showNotificationPopup(${n.id})"
                             data-notification-id="${n.id}">

                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <span class="${typeClass}">${n.type}</span>
                                    <h6 class="mb-1 mt-2">${n.title}</h6>
                                    <p class="mb-1 small text-muted">${n.message.length > 80 ? n.message.substring(0, 80) + '...' : n.message}</p>
                                    <small class="notification-time">
                                        <i class="bi bi-clock"></i> ${n.createdAt}
                                    </small>
                                </div>

                                <div class="notification-actions">
                                    <button class="delete-notification-btn"
                                            onclick="deleteNotification(event, ${n.id})"
                                            title="Supprimer">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="badge ${n.isRead ? 'bg-secondary' : 'bg-primary'}">
                                    ${badgeText}
                                </small>
                                ${!n.isRead ? `
                                    <button class="btn btn-sm btn-outline-success btn-sm"
                                            onclick="markAsRead(event, ${n.id})">
                                        <i class="bi bi-check"></i> Lu
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <hr class="my-2">
                    `;
                });

                container.innerHTML = html;
                updateNotificationBadge();
            })
            .catch(error => {
                console.error('Erreur lors du chargement des notifications:', error);
            });
    }

    // Fonction pour afficher la notification dans un popup
    function showNotificationPopup(notificationId) {
        fetch(`/notification/${notificationId}/details`)
            .then(response => response.json())
            .then(notification => {
                // Marquer comme lu automatiquement
                markAsRead(null, notificationId);

                Swal.fire({
                    title: notification.title,
                    html: `
                        <div class="text-start">
                            <span class="${getTypeClass(notification.type)} mb-2 d-inline-block">${notification.type}</span>
                            <p>${notification.message}</p>
                            <hr>
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> ${notification.createdAt}
                            </small>
                        </div>
                    `,
                    showCloseButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'Fermer',
                    cancelButtonText: 'Supprimer',
                    confirmButtonColor: '#0d6efd',
                    cancelButtonColor: '#dc3545',
                    showDenyButton: true,
                    denyButtonText: 'Marquer non lu'
                }).then((result) => {
                    if (result.isDenied) {
                        markAsUnread(notificationId);
                    } else if (result.isDismissed && result.dismiss === Swal.DismissReason.cancel) {
                        deleteNotification(null, notificationId);
                    }
                });
            });
    }

    // Fonction pour marquer une notification comme lue
    function markAsRead(event, notificationId) {
        if (event) event.stopPropagation();

        fetch(`/notification/${notificationId}/read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => {
                if (response.ok) {
                    // Mettre √† jour l'affichage
                    const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (item) {
                        item.classList.remove('unread');
                        item.classList.add('read');

                        // Cacher le bouton "Marquer comme lu"
                        const btn = item.querySelector('.btn-outline-success');
                        if (btn) btn.style.display = 'none';

                        // Mettre √† jour le badge
                        const badge = item.querySelector('.badge');
                        if (badge) {
                            badge.classList.remove('bg-primary');
                            badge.classList.add('bg-secondary');
                            badge.textContent = 'Lu';
                        }
                    }
                    updateNotificationBadge();
                }
            });
    }

    // Fonction pour marquer toutes les notifications comme lues
    function markAllAsRead() {
        fetch('/notifications/mark-all-read', {
            method: 'POST'
        })
            .then(response => {
                if (response.ok) {
                    // Recharger les notifications
                    loadNotifications();
                    Swal.fire('Succ√®s', 'Toutes les notifications ont √©t√© marqu√©es comme lues', 'success');
                }
            });
    }

    // Fonction pour marquer comme non lu
    function markAsUnread(notificationId) {
        fetch(`/notification/${notificationId}/unread`, {
            method: 'POST'
        })
            .then(response => {
                if (response.ok) {
                    loadNotifications();
                    Swal.fire('Succ√®s', 'Notification marqu√©e comme non lue', 'success');
                }
            });
    }

    // Fonction pour supprimer une notification
    function deleteNotification(event, notificationId) {
        if (event) event.stopPropagation();

        Swal.fire({
            title: 'Confirmer la suppression',
            text: "√ätes-vous s√ªr de vouloir supprimer cette notification ?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Oui, supprimer',
            cancelButtonText: 'Annuler'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/notification/${notificationId}/delete`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            // Supprimer l'√©l√©ment du DOM
                            const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
                            if (item) {
                                item.remove();
                                updateNotificationBadge();
                            }

                            Swal.fire(
                                'Supprim√© !',
                                'La notification a √©t√© supprim√©e.',
                                'success'
                            );
                        }
                    });
            }
        });
    }

    // Fonction pour mettre √† jour le badge de notifications
    function updateNotificationBadge() {
        fetch('{{ path("notifications_unread_count") }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Erreur lors de la r√©cup√©ration des notifications:', error);
                // Cacher le badge en cas d'erreur
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
            });
    }
    // Fonction utilitaire pour obtenir la classe CSS selon le type
    function getTypeClass(type) {
        const types = {
            'info': 'notification-type info',
            'warning': 'notification-type warning',
            'success': 'notification-type success',
            'error': 'notification-type error',
            'alert': 'notification-type warning'
        };
        return types[type.toLowerCase()] || 'notification-type info';
    }

    // Toggle sidebar sur mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
    }

    // Charger les notifications au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        // Charger le compte initial
        updateNotificationBadge();

        // Recharger les notifications toutes les 30 secondes
        setInterval(updateNotificationBadge, 30000);
    });
</script>
{% block javascripts %}{% endblock %}
</body>
</html>